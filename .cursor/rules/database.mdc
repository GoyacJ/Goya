---
alwaysApply: false
globs:
  - "**/component-database/**/*.java"
  - "**/*Mapper.java"
  - "**/*Repository.java"
  - "**/*Entity.java"
---

# 数据库专项规则

## 适用范围
本规则适用于所有数据库相关的代码开发，包括 Entity、Mapper、Repository 等。

## Entity 设计

### 基础 Entity

```java
/**
 * 基础 Entity
 * <p>
 * 所有 Entity 应继承 BaseEntity
 */
@Data
@MappedSuperclass
public abstract class BaseEntity {
    
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;
    
    private LocalDateTime createdAt;
    
    private String createdBy;
    
    private LocalDateTime updatedAt;
    
    private String updatedBy;
    
    @TableLogic
    private Boolean deleted;
}
```

### 业务 Entity

```java
/**
 * 用户 Entity
 */
@Data
@TableName("sys_user")
public class User extends BaseEntity {
    
    @TableField("username")
    private String username;
    
    @TableField("password")
    private String password;
    
    @TableField("mobile")
    private String mobile;
    
    @TableField("tenant_id")
    private String tenantId;
}
```

## 查询优化

### 避免 SELECT *

```java
// ❌ 错误
@Select("SELECT * FROM sys_user WHERE id = #{id}")
User findById(Long id);

// ✅ 正确
@Select("SELECT id, username, mobile FROM sys_user WHERE id = #{id}")
User findById(Long id);
```

### 使用索引

```sql
-- 创建索引
CREATE INDEX idx_username ON sys_user(username);
CREATE INDEX idx_mobile ON sys_user(mobile);
CREATE INDEX idx_tenant_username ON sys_user(tenant_id, username);
```

### 分页查询

```java
/**
 * 分页查询
 * <p>
 * 必须使用分页，避免一次查询大量数据
 */
public Page<User> pageUsers(UserQuery query) {
    Page<User> page = new Page<>(query.getPageNum(), query.getPageSize());
    
    LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
    wrapper.like(StringUtils.hasText(query.getUsername()), User::getUsername, query.getUsername())
           .eq(StringUtils.hasText(query.getTenantId()), User::getTenantId, query.getTenantId());
    
    return userMapper.selectPage(page, wrapper);
}
```

## 事务管理

### 事务注解

```java
/**
 * 事务管理
 * <p>
 * - 必须指定 rollbackFor
 * - 事务范围最小化
 * - 避免长事务
 */
@Transactional(rollbackFor = Exception.class)
public void createUser(User user) {
    userMapper.insert(user);
    
    // 发送事件（事务外）
    TransactionSynchronizationManager.registerSynchronization(
        new TransactionSynchronization() {
            @Override
            public void afterCommit() {
                eventPublisher.publishEvent(new UserCreatedEvent(user));
            }
        }
    );
}
```

### 避免长事务

```java
// ❌ 错误 - 长事务
@Transactional(rollbackFor = Exception.class)
public void processOrder(Order order) {
    orderMapper.insert(order);
    
    // 调用外部API（耗时操作）
    paymentService.pay(order);  // 不要在事务中
    
    // 发送邮件（耗时操作）
    emailService.send(order.getUserEmail());  // 不要在事务中
}

// ✅ 正确 - 短事务
@Transactional(rollbackFor = Exception.class)
public void createOrder(Order order) {
    orderMapper.insert(order);
}

public void processOrderAsync(Order order) {
    // 事务外调用
    paymentService.pay(order);
    emailService.send(order.getUserEmail());
}
```

## 多租户

### 租户隔离

```java
/**
 * 多租户拦截器
 */
@Component
public class TenantLineHandler implements TenantLineHandler {
    
    @Override
    public Expression getTenantId() {
        return new StringValue(TenantContext.getTenant());
    }
    
    @Override
    public String getTenantIdColumn() {
        return "tenant_id";
    }
    
    @Override
    public boolean ignoreTable(String tableName) {
        // 系统表不拦截
        return List.of("sys_config", "sys_dict").contains(tableName);
    }
}
```

## 性能优化

### 批量操作

```java
/**
 * 批量插入
 * <p>
 * 使用批量操作减少数据库交互
 */
public void batchInsert(List<User> users) {
    // MyBatis Plus 批量插入
    userService.saveBatch(users, 1000);  // 每批 1000 条
}
```

### 懒加载

```java
/**
 * 懒加载
 * <p>
 * 延迟加载关联数据
 */
@Data
@TableName("sys_order")
public class Order {
    
    private Long id;
    
    private Long userId;
    
    // 懒加载用户信息
    @TableField(exist = false)
    private User user;
}
```

### 缓存

```java
/**
 * 查询缓存
 */
@Service
public class UserService {
    
    @Cacheable(key = "'user:' + #id")
    public User getById(Long id) {
        return userMapper.selectById(id);
    }
    
    @CacheEvict(key = "'user:' + #user.id")
    public void update(User user) {
        userMapper.updateById(user);
    }
}
```

## 数据安全

### 字段加密

```java
/**
 * 敏感字段加密
 */
@Data
@TableName("sys_user")
public class User {
    
    @FieldEncrypt
    private String mobile;  // 手机号加密
    
    @FieldEncrypt
    private String idCard;  // 身份证号加密
}
```

### 软删除

```java
/**
 * 软删除
 */
@Data
@TableName("sys_user")
public class User {
    
    @TableLogic(value = "0", delval = "1")
    private Boolean deleted;
}
```

## 禁止事项

1. ❌ **禁止在循环中查询数据库**（N+1 问题）
2. ❌ **禁止不分页查询大表**
3. ❌ **禁止在事务中调用外部服务**
4. ❌ **禁止硬编码SQL**（使用 Mapper）
5. ❌ **禁止直接修改数据库**（通过代码修改）

## 最佳实践

1. ✅ **合理使用索引**
2. ✅ **小事务原则**
3. ✅ **读写分离**
4. ✅ **批量操作**
5. ✅ **缓存热点数据**

## 参考资料

- [MyBatis Plus 文档](https://baomidou.com/)
- [MySQL 性能优化](https://dev.mysql.com/doc/refman/8.0/en/optimization.html)
