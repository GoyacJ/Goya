---
alwaysApply: false
globs:
  - "**/*.java"
  - "**/pom.xml"
---

# Java 后端开发专项规则

## 适用范围
本规则适用于所有 Java 后端代码开发，包括 Spring Boot、MyBatis Plus、Spring Security 等相关开发。

## 命名规范

### 类命名
- **实体类**：`User`, `Order` (名词，大驼峰)
- **Service 接口**：`IUserService`, `IOrderService` (I前缀)
- **Service 实现**：`UserServiceImpl`, `OrderServiceImpl` (Impl后缀)
- **Controller**：`UserController`, `OrderController` (Controller后缀)
- **配置类**：`*AutoConfiguration`, `*Config`
- **常量接口**：`I*Constants`
- **枚举类**：`*Enum`
- **异常类**：`*Exception`

### 方法命名
- **查询单个**：`getById`, `findByUsername`
- **查询列表**：`listAll`, `findByCondition`
- **分页查询**：`pageByCondition`
- **保存**：`save`, `create`
- **更新**：`update`, `modify`
- **删除**：`delete`, `remove`
- **判断**：`exists`, `isValid`

### 包命名
- 基础包：`com.ysmjjsy.goya.{module}.{layer}`
- 示例：`com.ysmjjsy.goya.component.security.core.service`

## 注解使用

### 必须使用的注解

```java
// Lombok
@Slf4j              // 日志（所有类必须）
@Data               // Entity / DTO
@RequiredArgsConstructor  // Service（构造器注入）

// Spring
@Service            // Service 实现类
@RestController     // Controller
@Component          // 普通组件
@Configuration      // 配置类

// 事务
@Transactional(rollbackFor = Exception.class)  // 必须指定 rollbackFor
```

### 禁止使用的注解
```java
@Autowired  // 禁止字段注入，使用构造器注入
```

## 日志规范

### 日志格式

```java
// 组件注册
log.debug("[Goya] |- component [security] SecurityAutoConfiguration auto configure.");
log.trace("[Goya] |- component [security] |- bean [userService] register.");

// 业务日志
log.info("[Goya] |- User login success: {}", username);
log.warn("[Goya] |- Invalid token: {}", token);
log.error("[Goya] |- Database connection failed", exception);
```

### 日志级别使用
- **ERROR**：系统错误，需要立即处理
- **WARN**：警告信息，可能影响功能
- **INFO**：重要业务信息
- **DEBUG**：调试信息
- **TRACE**：详细追踪信息

## 注释规范

### 类注释

```java
/**
 * 用户服务实现类
 * <p>
 * 提供用户管理的核心业务逻辑，包括用户的创建、查询、更新和删除功能。
 * 所有方法都经过权限验证和数据校验。
 * 
 * <p>使用示例：
 * <pre>{@code
 * @Autowired
 * private IUserService userService;
 * 
 * User user = userService.getById(1L);
 * }</pre>
 *
 * @author goya
 * @since 2025-01-24
 * @see IUserService
 * @see User
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class UserServiceImpl implements IUserService {
    // 实现代码
}
```

### 方法注释

```java
/**
 * 根据用户 ID 查询用户信息
 * <p>
 * 此方法会先从缓存中查询，如果缓存未命中则从数据库查询并更新缓存。
 * 查询结果不包含用户密码等敏感信息。
 *
 * @param userId 用户 ID，不能为 null
 * @return 用户信息，如果用户不存在则返回 null
 * @throws IllegalArgumentException 如果 userId 为 null
 */
@Override
public User getById(Long userId) {
    Assert.notNull(userId, "userId cannot be null");
    log.debug("[Goya] |- Fetching user by id: {}", userId);
    return userRepository.findById(userId).orElse(null);
}
```

## 代码规范

### 构造器注入

```java
// ✅ 正确 - 使用构造器注入
@Service
@RequiredArgsConstructor
public class UserService {
    private final UserRepository userRepository;
    private final CacheService cacheService;
}

// ❌ 错误 - 不要使用字段注入
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
}
```

### 异常处理

```java
// ✅ 正确
@Transactional(rollbackFor = Exception.class)
public void createUser(User user) {
    try {
        userRepository.save(user);
    } catch (DataIntegrityViolationException e) {
        log.error("[Goya] |- User creation failed: duplicate username", e);
        throw new BusinessException("用户名已存在");
    }
}

// ❌ 错误 - 不要吞掉异常
public void createUser(User user) {
    try {
        userRepository.save(user);
    } catch (Exception e) {
        // 什么都不做
    }
}
```

### 空值判断

```java
// ✅ 正确 - 使用 Assert
public User getById(Long id) {
    Assert.notNull(id, "id cannot be null");
    return userRepository.findById(id).orElse(null);
}

// ✅ 正确 - 使用 Optional
public Optional<User> findById(Long id) {
    return userRepository.findById(id);
}
```

## MyBatis Plus 规范

### Entity 定义

```java
@Data
@TableName("sys_user")
public class User extends BaseEntity {
    
    @TableId(type = IdType.ASSIGN_ID)
    private Long id;
    
    @TableField("username")
    private String username;
    
    @FieldEncrypt
    private String mobile;
    
    @TableLogic
    private Boolean deleted;
}
```

### Mapper 定义

```java
@Mapper
public interface UserMapper extends BaseMapper<User> {
    
    /**
     * 根据用户名查询用户
     */
    @Select("SELECT * FROM sys_user WHERE username = #{username} AND deleted = 0")
    User findByUsername(@Param("username") String username);
}
```

## Spring Security 规范

### 密码加密

```java
// ✅ 正确 - 使用 BCrypt
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder(10);
}

// 加密密码
String encodedPassword = passwordEncoder.encode(rawPassword);
```

### 权限验证

```java
// ✅ 使用注解
@PreAuthorize("hasRole('ADMIN')")
public void deleteUser(Long id) {
    userRepository.deleteById(id);
}

// ✅ 编程式验证
public void updateUser(User user) {
    if (!hasPermission("user:write")) {
        throw new AccessDeniedException("无权限");
    }
    userRepository.save(user);
}
```

## 性能优化

### 避免 N+1 查询

```java
// ❌ 错误 - N+1 查询
List<Order> orders = orderRepository.findAll();
for (Order order : orders) {
    User user = userRepository.findById(order.getUserId());  // N 次查询
}

// ✅ 正确 - 批量查询
List<Order> orders = orderRepository.findAll();
Set<Long> userIds = orders.stream()
    .map(Order::getUserId)
    .collect(Collectors.toSet());
Map<Long, User> userMap = userRepository.findByIds(userIds).stream()
    .collect(Collectors.toMap(User::getId, Function.identity()));
```

### 合理使用缓存

```java
@Service
public class UserService {
    
    @Cacheable(key = "'user:' + #id")
    public User getById(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    @CacheEvict(key = "'user:' + #user.id")
    public void update(User user) {
        userRepository.save(user);
    }
}
```

## 禁止事项

1. ❌ **禁止使用拼音命名**
2. ❌ **禁止使用下划线命名**（数据库字段除外）
3. ❌ **禁止使用尾行注释**
4. ❌ **禁止捕获异常后什么都不做**
5. ❌ **禁止在循环中操作数据库**
6. ❌ **禁止硬编码配置信息**
7. ❌ **禁止使用 `System.out.println`**，使用日志
8. ❌ **禁止提交敏感信息**（密码、密钥等）

## 最佳实践

1. ✅ **单一职责**：一个类只做一件事
2. ✅ **最小化可见性**：默认使用 `private`
3. ✅ **不可变对象**：优先使用 `final`
4. ✅ **及早返回**：减少嵌套层级
5. ✅ **明确命名**：让代码自解释
6. ✅ **小方法**：单个方法不超过 50 行
7. ✅ **测试覆盖**：核心逻辑必须有单元测试

## 参考资料

- [阿里巴巴 Java 开发手册](https://github.com/alibaba/p3c)
- [Google Java Style Guide](https://google.github.io/styleguide/javaguide.html)
- [Spring Boot 最佳实践](https://docs.spring.io/spring-boot/docs/current/reference/html/)
